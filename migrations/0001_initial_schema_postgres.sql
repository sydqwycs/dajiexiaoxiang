-- 大街小巷选择系统 - 初始数据库架构
-- 创建时间: 2026-01-14

-- 创建 polls 表（选择活动）
CREATE TABLE IF NOT EXISTS polls (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title TEXT NOT NULL,
    deadline TIMESTAMP NOT NULL,
    status TEXT NOT NULL DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建 vote_options 表（选择选项）
CREATE TABLE IF NOT EXISTS vote_options (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    poll_id UUID NOT NULL REFERENCES polls(id) ON DELETE CASCADE,
    option_text TEXT NOT NULL,
    display_order INTEGER NOT NULL
);

-- 创建 votes 表（投票记录）
CREATE TABLE IF NOT EXISTS votes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    poll_id UUID NOT NULL REFERENCES polls(id) ON DELETE CASCADE,
    option_id UUID NOT NULL REFERENCES vote_options(id) ON DELETE CASCADE,
    ip_address TEXT NOT NULL,
    voted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(poll_id, ip_address)
);

-- 创建索引以提高查询性能
CREATE INDEX IF NOT EXISTS idx_polls_status ON polls(status);
CREATE INDEX IF NOT EXISTS idx_polls_deadline ON polls(deadline);
CREATE INDEX IF NOT EXISTS idx_vote_options_poll_id ON vote_options(poll_id);
CREATE INDEX IF NOT EXISTS idx_votes_poll_id ON votes(poll_id);
CREATE INDEX IF NOT EXISTS idx_votes_option_id ON votes(option_id);
CREATE INDEX IF NOT EXISTS idx_votes_ip_poll ON votes(poll_id, ip_address);

-- 插入测试数据（3个历史选择）
-- 1. 最喜欢的季节（10票）
INSERT INTO polls (id, title, deadline, status, created_at, updated_at)
VALUES 
    ('11111111-1111-1111-1111-111111111111', '最喜欢的季节', '2025-12-31 23:59:59', 'closed', '2025-12-01 00:00:00', '2025-12-01 00:00:00');

INSERT INTO vote_options (id, poll_id, option_text, display_order)
VALUES 
    ('11111111-1111-1111-1111-111111111112', '11111111-1111-1111-1111-111111111111', '春天', 1),
    ('11111111-1111-1111-1111-111111111113', '11111111-1111-1111-1111-111111111111', '夏天', 2),
    ('11111111-1111-1111-1111-111111111114', '11111111-1111-1111-1111-111111111111', '秋天', 3),
    ('11111111-1111-1111-1111-111111111115', '11111111-1111-1111-1111-111111111111', '冬天', 4);

-- 为"最喜欢的季节"添加10票
INSERT INTO votes (poll_id, option_id, ip_address, voted_at)
VALUES 
    ('11111111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111112', '192.168.1.1', '2025-12-02 10:00:00'),
    ('11111111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111112', '192.168.1.2', '2025-12-02 10:05:00'),
    ('11111111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111113', '192.168.1.3', '2025-12-02 10:10:00'),
    ('11111111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111113', '192.168.1.4', '2025-12-02 10:15:00'),
    ('11111111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111113', '192.168.1.5', '2025-12-02 10:20:00'),
    ('11111111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111114', '192.168.1.6', '2025-12-02 10:25:00'),
    ('11111111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111114', '192.168.1.7', '2025-12-02 10:30:00'),
    ('11111111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111114', '192.168.1.8', '2025-12-02 10:35:00'),
    ('11111111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111115', '192.168.1.9', '2025-12-02 10:40:00'),
    ('11111111-1111-1111-1111-111111111111', '11111111-1111-1111-1111-111111111115', '192.168.1.10', '2025-12-02 10:45:00');

-- 2. 最喜欢的编程语言（12票）
INSERT INTO polls (id, title, deadline, status, created_at, updated_at)
VALUES 
    ('22222222-2222-2222-2222-222222222222', '最喜欢的编程语言', '2025-11-30 23:59:59', 'closed', '2025-11-01 00:00:00', '2025-11-01 00:00:00');

INSERT INTO vote_options (id, poll_id, option_text, display_order)
VALUES 
    ('22222222-2222-2222-2222-222222222223', '22222222-2222-2222-2222-222222222222', 'Python', 1),
    ('22222222-2222-2222-2222-222222222224', '22222222-2222-2222-2222-222222222222', 'JavaScript', 2),
    ('22222222-2222-2222-2222-222222222225', '22222222-2222-2222-2222-222222222222', 'TypeScript', 3),
    ('22222222-2222-2222-2222-222222222226', '22222222-2222-2222-2222-222222222222', 'Java', 4);

-- 为"最喜欢的编程语言"添加12票
INSERT INTO votes (poll_id, option_id, ip_address, voted_at)
VALUES 
    ('22222222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222223', '192.168.2.1', '2025-11-02 10:00:00'),
    ('22222222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222223', '192.168.2.2', '2025-11-02 10:05:00'),
    ('22222222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222223', '192.168.2.3', '2025-11-02 10:10:00'),
    ('22222222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222224', '192.168.2.4', '2025-11-02 10:15:00'),
    ('22222222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222224', '192.168.2.5', '2025-11-02 10:20:00'),
    ('22222222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222224', '192.168.2.6', '2025-11-02 10:25:00'),
    ('22222222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222224', '192.168.2.7', '2025-11-02 10:30:00'),
    ('22222222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222225', '192.168.2.8', '2025-11-02 10:35:00'),
    ('22222222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222225', '192.168.2.9', '2025-11-02 10:40:00'),
    ('22222222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222225', '192.168.2.10', '2025-11-02 10:45:00'),
    ('22222222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222226', '192.168.2.11', '2025-11-02 10:50:00'),
    ('22222222-2222-2222-2222-222222222222', '22222222-2222-2222-2222-222222222226', '192.168.2.12', '2025-11-02 10:55:00');

-- 3. 周末活动偏好（15票）
INSERT INTO polls (id, title, deadline, status, created_at, updated_at)
VALUES 
    ('33333333-3333-3333-3333-333333333333', '周末活动偏好', '2025-10-31 23:59:59', 'closed', '2025-10-01 00:00:00', '2025-10-01 00:00:00');

INSERT INTO vote_options (id, poll_id, option_text, display_order)
VALUES 
    ('33333333-3333-3333-3333-333333333334', '33333333-3333-3333-3333-333333333333', '户外运动', 1),
    ('33333333-3333-3333-3333-333333333335', '33333333-3333-3333-3333-333333333333', '看电影', 2),
    ('33333333-3333-3333-3333-333333333336', '33333333-3333-3333-3333-333333333333', '读书', 3),
    ('33333333-3333-3333-3333-333333333337', '33333333-3333-3333-3333-333333333333', '聚会', 4);

-- 为"周末活动偏好"添加15票
INSERT INTO votes (poll_id, option_id, ip_address, voted_at)
VALUES 
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333334', '192.168.3.1', '2025-10-02 10:00:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333334', '192.168.3.2', '2025-10-02 10:05:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333334', '192.168.3.3', '2025-10-02 10:10:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333334', '192.168.3.4', '2025-10-02 10:15:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333335', '192.168.3.5', '2025-10-02 10:20:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333335', '192.168.3.6', '2025-10-02 10:25:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333335', '192.168.3.7', '2025-10-02 10:30:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333335', '192.168.3.8', '2025-10-02 10:35:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333336', '192.168.3.9', '2025-10-02 10:40:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333336', '192.168.3.10', '2025-10-02 10:45:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333336', '192.168.3.11', '2025-10-02 10:50:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333337', '192.168.3.12', '2025-10-02 10:55:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333337', '192.168.3.13', '2025-10-02 11:00:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333337', '192.168.3.14', '2025-10-02 11:05:00'),
    ('33333333-3333-3333-3333-333333333333', '33333333-3333-3333-3333-333333333337', '192.168.3.15', '2025-10-02 11:10:00');
